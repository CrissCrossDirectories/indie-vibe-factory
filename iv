#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# Indie Vibe HQ â€” iv (front-door helper)
# Usage:
#   ./iv start <name> [--testing=vitest|jest]
#   ./iv continue <name>
#   ./iv list
# ============================================================

FACTORY_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECTS_DIR="${FACTORY_DIR}/projects"
SPAWN_SH="${FACTORY_DIR}/spawn.sh"
OPS_LOG="${FACTORY_DIR}/OPS_LOG.md"
TIMESTAMP="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"

log() {
  echo "[iv] $*"
  echo "- ${TIMESTAMP} | iv | $*" >> "${OPS_LOG}"
}

die() {
  echo "[iv] âŒ ERROR: $*" >&2
  exit 1
}

# --- Commands ---

cmd_start() {
  local name="${1:-}"
  shift || true
  [[ -n "$name" ]] || die "Usage: ./iv start <project-name> [--testing=vitest|jest]"
  log "Starting new project: ${name} $*"
  bash "${SPAWN_SH}" "$name" "$@"
}

cmd_continue() {
  local name="${1:-}"
  [[ -n "$name" ]] || die "Usage: ./iv continue <project-name>"

  local project_path="${PROJECTS_DIR}/${name}"
  if [[ ! -d "$project_path" ]]; then
    die "Project '${name}' not found at ${project_path}"
  fi

  log "Continuing project: ${name}"
  echo "[iv] Running verification gates for '${name}'..."
  cd "$project_path"

  echo ""
  echo "--- Gate 1/3: Lint ---"
  npm run lint || die "Lint failed for ${name}"
  echo "âœ… Lint passed"

  echo ""
  echo "--- Gate 2/3: Test ---"
  npm test || die "Tests failed for ${name}"
  echo "âœ… Tests passed"

  echo ""
  echo "--- Gate 3/3: Build ---"
  npm run build || die "Build failed for ${name}"
  echo "âœ… Build passed"

  echo ""
  echo "============================================================"
  echo "ðŸŸ¢ Project '${name}' is healthy â€” all gates passed."
  echo "   Path: ${project_path}"
  echo "============================================================"

  log "Project '${name}' gates passed successfully"
}

cmd_list() {
  echo ""
  echo "ðŸ“ Indie Vibe HQ Projects"
  echo "========================="

  if [[ ! -d "$PROJECTS_DIR" ]] || [[ -z "$(ls -A "$PROJECTS_DIR" 2>/dev/null)" ]]; then
    echo "  (no projects yet)"
    echo ""
    echo "  Create one: ./iv start <project-name>"
    return
  fi

  for dir in "${PROJECTS_DIR}"/*/; do
    if [[ -d "$dir" ]]; then
      local pname
      pname="$(basename "$dir")"
      local testing="unknown"

      # Detect testing framework
      if [[ -f "${dir}jest.config.ts" ]]; then
        testing="jest"
      elif [[ -f "${dir}vitest.config.ts" ]]; then
        testing="vitest"
      fi

      printf "  %-30s [%s]\n" "$pname" "$testing"
    fi
  done

  echo ""
  log "Listed projects"
}

# --- Router ---

COMMAND="${1:-}"
shift || true

case "$COMMAND" in
  start)    cmd_start "$@" ;;
  continue) cmd_continue "$@" ;;
  list)     cmd_list ;;
  "")       echo "Usage: ./iv <start|continue|list> [args...]" ;;
  *)        die "Unknown command: ${COMMAND}. Use: start, continue, list" ;;
esac
